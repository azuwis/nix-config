#!/usr/bin/env bash

jj op log --limit 1
echo

from=$1
if [ -z "$from" ]; then
  from="immutable_heads()"
fi

to=$2
if [ -z "$to" ]; then
  to="@-"
fi

last=$(jj log --color never --no-graph --limit 1 --template 'committer.timestamp().format("%s")' --revisions "roots(${from}..${to})-")

night="$(date +%s --date=19:00:00)"
new="$((night - 86400))"
mod=7200
if [ -n "$last" ] && [ "$last" -gt "$new" ] && [ "$last" -le "$((night - 68400))" ]; then
  new="$last"
  mod=600
fi

while read -r rev; do
  new="$((RANDOM % mod + 120 + new))"
  JJ_TIMESTAMP="$(date -Iseconds --date=@"$new")" jj describe --reset-author --no-edit "$rev"
done < <(jj log --no-graph --reversed --template 'change_id ++ "\n"' --revisions "${from}..${to}")

echo
jj log --revisions "${from}-..${to}"

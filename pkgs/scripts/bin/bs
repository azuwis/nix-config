#!/usr/bin/env bash

darwin_rebuild() {
  if [ "$1" = "u" ]
  then
    args=(--update-input darwin --update-input darwinHm --update-input darwinNixpkgs)
  else
    args=("$@")
  fi
  pushd ~/.config/nixpkgs || exit
  darwin-rebuild switch --flake . ${args[@]}
  popd || exit
}

droid_rebuild() {
  if [ "$1" = "u" ]
  then
    args=(--update-input droid --update-input droidHm --update-input droidNixpkgs)
  else
    args=("$@")
  fi
  nix-on-droid switch --flake "$HOME/.config/nixpkgs/#device" ${args[@]}
}

nixos_rebuild() {
  if [ "$1" = "u" ]
  then
    args=(--update-input nixos --update-input nixosHm)
  else
    args=("$@")
  fi
  sudo nixos-rebuild switch --flake '/etc/nixos' ${args[@]}
}

case "$(uname -s)" in
  Darwin)
    darwin_rebuild "$@"
    ;;
  Linux)
    if [[ -d /system/app/ && -d /system/priv-app ]]
    then
      droid_rebuild "$@"
    else
      nixos_rebuild "$@"
    fi
    ;;
esac
